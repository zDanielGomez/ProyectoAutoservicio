{% extends 'layout.html' %}
{% load static %}
{% block head %}
<title>Gestión de Respaldos</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="{% static 'css/styleB.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
    body {
        background-color: #f8f9fa;
        /* Color de fondo suave */
    }

    h1,
    h2 {
        color: #343a40;
        /* Color del texto */
    }

    .btn_generate {
        padding: 8px 16px;
        font-size: 1rem;
        border: none;
        border-radius: 5px;
        background-color: #28a745;
        /* Color verde */
        color: white;
        cursor: pointer;
    }

    .btn_generate:hover {
        background-color: #218838;
        /* Color verde oscuro al pasar el mouse */
    }

    .table {
        margin-top: 20px;
        background-color: white;
        border: 1px solid rgba(3, 63, 99, 1);
        /* Borde de la tabla */
    }

    .table th,
    .table td {
        text-align: center;
        border: 1px solid rgba(3, 63, 99, 1);
        /* Bordes de las celdas */
    }

    .table th {
        background-color: rgba(3, 63, 99, 1);
        color: white;
    }

    .btn {
        border: none;
        background-color: transparent;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .btn:hover {
        opacity: 0.8;
    }

    .btn-warning {
        color: yellow;
    }

    .btn-danger {
        color: red;
    }

    .add-backup-container {
        display: flex;
        justify-content: center;
        /* Centrado */
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        h1 {
            font-size: 1.5rem;
        }

        .btn_generate {
            width: 100%;
            font-size: 0.9rem;
        }

        .table {
            font-size: 0.9rem;
        }

        .add-backup-container {
            justify-content: center;
        }
    }
</style>


{% endblock %}
{% block contenido %}
<div class="container mt-5">
    <h1 class="text-center">Gestión de Respaldos</h1>
    <div>
        <h2 class="text-center">Copias de seguridad</h2>
        <div class="add-backup-container">
            <form id="backupForm" method="post" action="{% url 'app:crear_backup' %}">
                {% csrf_token %}
                <button class="btn_generate" type="submit"><i class="fas fa-plus-circle"></i> Agregar Backup</button>
            </form>
        </div>
        <div class="table-responsive">
            <table id="backupTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Nombre del Archivo</th>
                        <th>Fecha</th>
                        <th>Tamaño</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Los archivos de backup se cargarán aquí -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        const tableBody = $('#backupTable tbody');

        function formatDateTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString();
        }

        function loadBackupFiles() {
            $.get('{% url "app:listar_backup" %}', function (data) {
                tableBody.empty();
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }
                if (data.files.length === 0) {
                    const row = $('<tr><td colspan="4">No hay copias de seguridad generadas</td></tr>');
                    tableBody.append(row);
                } else {
                    data.files.forEach(file => {
                        const row = $(`
                            <tr>
                                <td>${file.filename}</td>
                                <td>${formatDateTime(file.created_at)}</td> 
                                <td>${(file.size / (1024 * 1024)).toFixed(2)} MB</td>
                                <td>
                                    <button class="btn select-file btn-warning" title="Restaurar" data-filename="${file.filename}">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="btn delete-file btn-danger" title="Eliminar" data-filename="${file.filename}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                        `);
                        tableBody.append(row);
                    });
                }
            }).fail(function (error) {
                console.error('Error:', error);
            });
        }

        loadBackupFiles();

        $('#backupForm').on('submit', function (event) {
            event.preventDefault();
            $.post($(this).attr('action'), $(this).serialize(), function (data) {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Copia de seguridad creada correctamente',
                        text: data.message,
                        confirmButtonText: 'Aceptar'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonText: 'Aceptar'
                    });
                }
                loadBackupFiles(); // Refresca la lista de archivos
            });
        });

        tableBody.on('click', '.select-file', function () {
            const filename = $(this).data('filename');
            Swal.fire({
                title: '¿Restaurar copia de seguridad?',
                text: `¿Está seguro que desea restaurar el archivo: ${filename}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, restaurar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#218838',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('{% url "app:restaurar_backup" %}', { filename: filename, csrfmiddlewaretoken: '{{ csrf_token }}' }, function (data) {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Copia de seguridad restaurada correctamente',
                                text: data.message,
                                confirmButtonText: 'Aceptar'
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                confirmButtonText: 'Aceptar'
                            });
                        }
                        loadBackupFiles(); // Refresca la lista de archivos
                    }).fail(function (error) {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Ocurrió un error inesperado.',
                            confirmButtonText: 'Aceptar'
                        });
                    });
                }
            });
        });

        tableBody.on('click', '.delete-file', function () {
            const filename = $(this).data('filename');
            Swal.fire({
                title: '¿Eliminar copia de seguridad?',
                text: `¿Está seguro de eliminar el archivo: ${filename}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('{% url "app:eliminar_backup" %}', { filename: filename, csrfmiddlewaretoken: '{{ csrf_token }}' }, function (data) {
                        if (data.success) {
                            Swal.fire('Eliminado', data.message, 'success');
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                        loadBackupFiles(); // Refresca la lista de archivos
                    }).fail(function (error) {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Ocurrió un error inesperado.',
                            confirmButtonText: 'Aceptar'
                        });
                    });
                }
            });
        });
    });
</script>
{% endblock %}